<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.54">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.4/mermaid.min.js"></script>
<script src="/init.js"></script>

<title data-react-helmet="true">Events | EmbraceSQL</title>

<meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Events | EmbraceSQL"><meta data-react-helmet="true" name="description" content="## Getting Started"><meta data-react-helmet="true" property="og:description" content="## Getting Started"><meta data-react-helmet="true" property="og:url" content=" https://embracesql.github.io//events">

<link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico">


<link rel="stylesheet" href="/styles.8f84c745.css">


<link rel="preload" href="/styles.54b0c4a3.js" as="script">

<link rel="preload" href="/runtime~main.7ec10ac3.js" as="script">

<link rel="preload" href="/main.31cdcd81.js" as="script">

<link rel="preload" href="/1.23d10dc5.js" as="script">

<link rel="preload" href="/2.89a20604.js" as="script">

<link rel="preload" href="/20.26c77945.js" as="script">

<link rel="preload" href="/ec1ed54d.70f87ed0.js" as="script">

<link rel="preload" href="/17896441.a81c94af.js" as="script">

<link rel="preload" href="/19.6bdbe1e9.js" as="script">

<link rel="preload" href="/3ee9ac3f.d22d123d.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">EmbraceSQL</strong></a><a class="navbar__item navbar__link" href="/">Docs</a></div><div class="navbar__items navbar__items--right"><a target="_blank" rel="noopener noreferrer" href="https://github.com/civitaslearning/embrace-sql" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">EmbraceSQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/">Docs</a></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://github.com/civitaslearning/embrace-sql" class="menu__link" position="right">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Overview</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/index">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/databases">Databases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tables">Tables</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/sqlmodules">SQL Modules</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/security">Security</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Workflow</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/deploying">Deploying</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" tabindex="0" href="/events">Events</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/problems">Problems</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/interfaces">Interfaces</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">Events</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="getting-started"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#getting-started" title="Direct link to heading">#</a>Getting Started</h2><p>One of the big choices in system design is CRUD or some form of EventSourcing / CQRS setup. EmbraceSQL -- embraces SQL -- Câ€™s are UPDATE/INSERT/DELETE and Qâ€™s are SELECT. They are separated by SQL itself. So CQRS is â€˜freeâ€™, in fact SQL has had this notion all along.</p><p>Now for the event sourcing part.
By default every command generates an event internal to the EmbraceSQL event processing system. EmbraceSQL itself uses an event driven architecture, starting with an API request, running through multiple event handlers, and finally returning results or an error.
Commands - INSERT/UPDATE/DELETE -- can be twinned to a Kafka topic, so that any time the database is to be modified, other services can be informed. When one of these commands is detected, the entire originating request, encoded as JSON is placed in the topic as a message, along with the SQL. These events let you see:</p><ul><li>Who: the originating request context contains a user token if authenticated</li><li>What: the resulting SQL and Parameters</li><li>When: total ordering of events in Kafka</li><li>Why: the originating request and paramters resulting from an API call or REST</li></ul><div class="mdxCodeBlock_iHAB"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_U1PS">./embracesql.yml</div><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_19pQ codeBlockWithTitle_2fj3"><div class="codeBlockLines_2n9r" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">twinCommandsTo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> kafka</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">port/topic</span></div></div></div></div></div><p>There is actually a bit more than that -- EmbraceSQL internally runs off message streams, when you call an API, the inputs are enqueued, and run through each handler, as well as for the database query itself.
EmbraceSQL is itself a SQL EventSourcing system -- where the events <em>are</em> the SQL modules, and the handlers are handling events.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="event-flow"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#event-flow" title="Direct link to heading">#</a>Event Flow</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="sql-modules"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#sql-modules" title="Direct link to heading">#</a>SQL Modules</h3><div class="mermaid">
sequenceDiagram
  participant Client
  participant EmbraceSQL
  participant Handler
  participant Database
  participant Kafka
  Client-&gt;&gt;+EmbraceSQL: SQLAPI or AutoCRUD at URL with parameters
  EmbraceSQL-&gt;&gt;+Handler: validateToken
  Handler--&gt;-EmbraceSQL: ...
  EmbraceSQL-&gt;&gt;+Handler: resolveSQL
  Handler--&gt;-EmbraceSQL: ...
  EmbraceSQL-&gt;&gt;+Handler: beforeStreamMessage
  Handler--&gt;-EmbraceSQL: ...
  EmbraceSQL-xKafka: stream context as message
  EmbraceSQL-&gt;&gt;+Handler: beforeBatch chain
  Handler--&gt;-EmbraceSQL: ...
  EmbraceSQL-&gt;&gt;Database: transaction begin
  activate Database
  loop each batch entry
    EmbraceSQL-&gt;&gt;+Handler: before chain
    Handler--&gt;-EmbraceSQL: ...
    EmbraceSQL-&gt;&gt;Database: sql + parameters
    Database--&gt;EmbraceSQL: results returned
    EmbraceSQL-&gt;&gt;+Handler: after chain
    Handler--&gt;-EmbraceSQL: ...
    opt Errors
      EmbraceSQL-&gt;&gt;+Handler: afterError chain
      Handler--&gt;-EmbraceSQL: ...
    end
  end
  EmbraceSQL-&gt;&gt;+Handler: afterBatch chain
  Handler--&gt;-EmbraceSQL: ...
  alt error unhandled
    EmbraceSQL-&gt;&gt;Database: transaction rollback
  else
    EmbraceSQL-&gt;&gt;Database: transaction commit
  end
  deactivate Database
  EmbraceSQL--&gt;-Client: context.results returned
</div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="data-events"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#data-events" title="Direct link to heading">#</a>Data Events</h2><p>Data events are the main point you can customize SQL modules. All data handlers are hierarchial, with two chains &#x27;before&#x27; and &#x27;after&#x27;. Before chains run from the root folder down the file hierarchy toward your SQL file, after chains run from the final folder with the SQL up the file hierarchy.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="beforebatch"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#beforebatch" title="Direct link to heading">#</a><code>beforeBatch</code></h3><p>Everything exists in the context of a batch, though sometimes that batch has just one entry. Right before the batch starts its initial transaction, this handler gives you a chance to look at all the data to be processed in the batch.</p><p>This is a place you can pre-clean a batch, removing entries so that they do not run at all, or adding additional parameters to every batch entry.</p><p>Once this event is handled, EmbraceSQL will iterate every remaining entry in the batch.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="before"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#before" title="Direct link to heading">#</a><code>before</code></h3><p>Each of the folder hierarchy based <code>before</code> handlers has a service queue, automatically defined, so that each folder, and each sql file has a before handling queue. Messages are placed in the root folder before handler, handled, and then passed down the folder hierarchy until a query is reached.</p><p>After the <code>before</code> handlers are processed, the resulting <code>context</code> is presented to a pool of SQL processing queues for each attached database. This allows concurrent data access without resorting to multithreading or traditional connection pooling.</p><p>When a query completes, the resulting data is attached to the context and passed back up the chain as <code>after</code> events.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="after"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#after" title="Direct link to heading">#</a><code>after</code></h3><p>Each folder in the hierarchy, and the sql file itself has an automatically defined <code>after</code> event queue, which run in the reverse order as <code>before</code> events, from the sql file back to the root directory. Each handler runs, and passed up to the subsequent queue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="afterbatch"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#afterbatch" title="Direct link to heading">#</a><code>afterBatch</code></h3><p>After the last set of parameters is processed, which can always be a &#x27;batch of one&#x27;, right before the batch transaction is committed, you have an event to handle.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="aftererror"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#aftererror" title="Direct link to heading">#</a><code>afterError</code></h3><p>Unhandled exceptions raised in any handler in a chain, including coming from the supporting database engine, are handed here. You can do nothing, which continues the exception.
If you handle an exception, and do not raise another, and set <code>context.error = null</code>, EmbraceSQL treats it like no error happened, just like if you had wrapped your handler code in <code>try{} catch{}</code> and caught it.</p><p>You can also handle exceptions normally in handler code as you see fit. This event acts as a backstop.</p><p>There is no <code>beforeError</code>, EmbraceSQL is not psychic ðŸ”®.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="system-events"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#system-events" title="Direct link to heading">#</a>System Events</h2><p>While data events fire in response to SQL module invocations, system events can fire at any time.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="validatetoken"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#validatetoken" title="Direct link to heading">#</a><code>validateToken</code></h3><p>OpenID Connect authorization tokens are decoded and validated by default. But you can provide your own event handler that does your own token validation.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="resolvesql"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#resolvesql" title="Direct link to heading">#</a><code>resolveSQL</code></h3><p>SQL module inovcations resovle to chain of event handlers and associated SQL. The <code>resolve</code> event lets you tap into this and replace any handler or SQL you like, running <em>before</em> the first <code>before</code> handler.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="beforestreammessage"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#beforestreammessage" title="Direct link to heading">#</a><code>beforeStreamMessage</code></h3><p>When connected to an external message stream, just before a message is to be sent to an external message stream, you have a chance to intercept it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="beforemigration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#beforemigration" title="Direct link to heading">#</a><code>beforeMigration</code></h3><p>Just before a migration is going to start, this event is fired for each distinct migration SQL script that will run.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="aftermigration"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#aftermigration" title="Direct link to heading">#</a><code>afterMigration</code></h3><p>After the migration, this event is fired for each distinct migration SQL.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="handlers"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#handlers" title="Direct link to heading">#</a>Handlers</h2><p>Handlers are <code>async</code> JavaScript or TypeScript functions, that receive a <code>context</code>, run code as you see fit, and either throw an error or return.
The <code>context</code> is modified in place, and serves as a shared blackboard for each request.</p><p>Handlers go one per file, with the file ending in [event-name].[js|ts], exporting a single function named by [event-name].</p><p>EmbraceSQL will generate empty handlers for you for each folder, for each sql file, and for the system level event handlers.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/civitaslearning/embrace-sql/edit/master/docs/events.mdx" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/deploying"><div class="pagination-nav__link--sublabel">Previous</div><div class="pagination-nav__link--label">Â« Deploying</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/problems"><div class="pagination-nav__link--sublabel">Next</div><div class="pagination-nav__link--label">Problems Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#getting-started" class="contents__link">Getting Started</a></li><li><a href="#event-flow" class="contents__link">Event Flow</a><ul><li><a href="#sql-modules" class="contents__link">SQL Modules</a></li></ul></li><li><a href="#data-events" class="contents__link">Data Events</a><ul><li><a href="#beforebatch" class="contents__link"><code>beforeBatch</code></a></li><li><a href="#before" class="contents__link"><code>before</code></a></li><li><a href="#after" class="contents__link"><code>after</code></a></li><li><a href="#afterbatch" class="contents__link"><code>afterBatch</code></a></li><li><a href="#aftererror" class="contents__link"><code>afterError</code></a></li></ul></li><li><a href="#system-events" class="contents__link">System Events</a><ul><li><a href="#validatetoken" class="contents__link"><code>validateToken</code></a></li><li><a href="#resolvesql" class="contents__link"><code>resolveSQL</code></a></li><li><a href="#beforestreammessage" class="contents__link"><code>beforeStreamMessage</code></a></li><li><a href="#beforemigration" class="contents__link"><code>beforeMigration</code></a></li><li><a href="#aftermigration" class="contents__link"><code>afterMigration</code></a></li></ul></li><li><a href="#handlers" class="contents__link">Handlers</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>Copyright Â© 2020 Civitas Learning, Inc. Built with Docusaurus.</div></div></div></footer>
</div>

<script src="/styles.54b0c4a3.js"></script>

<script src="/runtime~main.7ec10ac3.js"></script>

<script src="/main.31cdcd81.js"></script>

<script src="/1.23d10dc5.js"></script>

<script src="/2.89a20604.js"></script>

<script src="/20.26c77945.js"></script>

<script src="/ec1ed54d.70f87ed0.js"></script>

<script src="/17896441.a81c94af.js"></script>

<script src="/19.6bdbe1e9.js"></script>

<script src="/3ee9ac3f.d22d123d.js"></script>


</body>
</html>